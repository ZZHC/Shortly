<!DOCTYPE html>
<html>
    <head>
        <title>goo.gl OAuth Finish!</title>
        <script src="jsOAuth-mod.js"></script>
        <script src="../jquery-1.4.2.min.js"></script>
    </head>
    <body>
      <h1>Congratulations!</h1>
      <p>You've finished the OAuth process with Google, and Shortly can now shorten links on behalf of you. All links you shorten from now on will leave a history log on your Google Account. Please visit <a href="http://code.google.com/apis/urlshortener/">Google URL Shortener API</a> for more information.</p>
      
      <script>
        var url = location.href;
        var oauth_token_secret = localStorage.getItem('googl_oauth_token_secret');
        
        if(oauth_token_secret == null) {
          alert('Fail');
        }
        
        var queryParse = function(uri) {
          var queryStrArray = uri.split('?')[1].split('&');
          var queryHash = {};
          
          $.each(queryStrArray, function(index, value) {
            var param = value.split('=');  
            queryHash[param[0]] = decodeURIComponent(param[1]);
          });
    
          return queryHash;
        };
  
        var tokens = queryParse(url);
        
        /* @@ Setting up for exchanging Access Token @@ */
        
         var options = {
            consumerKey: 'anonymous',
            consumerSecret: 'anonymous',
            accessTokenKey: tokens.oauth_token,
            accessTokenSecret: oauth_token_secret,
            verifier: tokens.oauth_verifier
          };

          var oauthAccessTokenExchanger = OAuth(options);
          
          /* @@ Ask to exchange Access Token @@ */

          oauthAccessTokenExchanger.get('https://www.google.com/accounts/OAuthGetAccessToken', function (data) {
              var oauth_token = data.text.match(/oauth_token=([^\&]+)/)[1];
              var oauth_token_secret = data.text.match(/oauth_token_secret=([^\&]+)/)[1];

              /* @@ Create an event to inform injected script @@ */

              var ocevt = document.createEvent('Event');
              ocevt.initEvent('oauthComplete', false, true);
          
              localStorage.setItem('googl_oauth_token', decodeURIComponent(oauth_token));
              localStorage.setItem('googl_oauth_token_secret', decodeURIComponent(oauth_token_secret));
              
              /* @@ Tell injected script to save tokens @@ */

              document.dispatchEvent(ocevt);
          });

        
      </script>
    </body>
</html>

